
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>FeatureCloud.app.engine.app &#8212; Featurecloud  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/alabaster.css" />
    <script data-url_root="../../../../" id="documentation_options" src="../../../../_static/documentation_options.js"></script>
    <script src="../../../../_static/jquery.js"></script>
    <script src="../../../../_static/underscore.js"></script>
    <script src="../../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
   
  <link rel="stylesheet" href="../../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for FeatureCloud.app.engine.app</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Test module documentation string for app.py</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">abc</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">traceback</span>

<span class="kn">from</span> <span class="nn">enum</span> <span class="kn">import</span> <span class="n">Enum</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">sleep</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">TypedDict</span><span class="p">,</span> <span class="n">Literal</span>

<span class="n">DATA_POLL_INTERVAL</span> <span class="o">=</span> <span class="mf">0.1</span>  <span class="c1"># Interval (seconds) to check for new data pieces, adapt if necessary</span>
<span class="n">TERMINAL_WAIT</span> <span class="o">=</span> <span class="mi">10</span>  <span class="c1"># Time (seconds) to wait before final shutdown, to allow the controller to pick up the newest</span>
<span class="c1"># progress etc.</span>
<span class="n">TRANSITION_WAIT</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># Time (seconds) to wait between state transitions</span>


<div class="viewcode-block" id="Role"><a class="viewcode-back" href="../../../../code.html#FeatureCloud.app.engine.app.Role">[docs]</a><span class="k">class</span> <span class="nc">Role</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    | Describes the Role of a client</span>
<span class="sd">    | Can be one of the following values:</span>
<span class="sd">    | Role.PARTICIPANT</span>
<span class="sd">    | Role.COORDINATOR</span>
<span class="sd">    | Role.BOTH</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">PARTICIPANT</span> <span class="o">=</span> <span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="n">COORDINATOR</span> <span class="o">=</span> <span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="n">BOTH</span> <span class="o">=</span> <span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span></div>


<span class="k">class</span> <span class="nc">State</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    | Describes the current State of the app instance</span>
<span class="sd">    | Can be one of the following values:</span>
<span class="sd">    | State.RUNNING</span>
<span class="sd">    | State.ERROR</span>
<span class="sd">    | State.ACTION</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">RUNNING</span> <span class="o">=</span> <span class="s1">&#39;running&#39;</span>
    <span class="n">ERROR</span> <span class="o">=</span> <span class="s1">&#39;error&#39;</span>
    <span class="n">ACTION</span> <span class="o">=</span> <span class="s1">&#39;action_required&#39;</span>


<div class="viewcode-block" id="SMPCOperation"><a class="viewcode-back" href="../../../../code.html#FeatureCloud.app.engine.app.SMPCOperation">[docs]</a><span class="k">class</span> <span class="nc">SMPCOperation</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    | It&#39;s parameters are used to describe SMPC Operations for other functions</span>
<span class="sd">    | One of the following:</span>
<span class="sd">    | SMPCOperation.ADD</span>
<span class="sd">    | SMPCOperation.MULTIPLY</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ADD</span> <span class="o">=</span> <span class="s1">&#39;add&#39;</span>
    <span class="n">MULTIPLY</span> <span class="o">=</span> <span class="s1">&#39;multiply&#39;</span></div>


<div class="viewcode-block" id="SMPCSerialization"><a class="viewcode-back" href="../../../../code.html#FeatureCloud.app.engine.app.SMPCSerialization">[docs]</a><span class="k">class</span> <span class="nc">SMPCSerialization</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    | Describes the serialization used with data when using SMPC, so the format data is send between different components of Featurecloud, e.g. between the app instance and the controller</span>
<span class="sd">    | Currently ony the following is supported</span>
<span class="sd">    | SMPCSerialization.JSON</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">JSON</span> <span class="o">=</span> <span class="s1">&#39;json&#39;</span></div>


<div class="viewcode-block" id="LogLevel"><a class="viewcode-back" href="../../../../code.html#FeatureCloud.app.engine.app.LogLevel">[docs]</a><span class="k">class</span> <span class="nc">LogLevel</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    | The level of a log, given to the log function.</span>
<span class="sd">    | LogLevel.DEBUG: Just for debugging</span>
<span class="sd">    | LogLevel.ERROR: Throws an error but does not halt the program</span>
<span class="sd">    | LogLevel.FATAL: Stops the program</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">DEBUG</span> <span class="o">=</span> <span class="s1">&#39;info&#39;</span>
    <span class="n">ERROR</span> <span class="o">=</span> <span class="s1">&#39;error&#39;</span>
    <span class="n">FATAL</span> <span class="o">=</span> <span class="s1">&#39;fatal&#39;</span></div>


<span class="k">class</span> <span class="nc">SMPCType</span><span class="p">(</span><span class="n">TypedDict</span><span class="p">):</span>
    <span class="n">operation</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s1">&#39;add&#39;</span><span class="p">,</span> <span class="s1">&#39;multiply&#39;</span><span class="p">]</span>
    <span class="n">serialization</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s1">&#39;json&#39;</span><span class="p">]</span>
    <span class="n">shards</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">exponent</span><span class="p">:</span> <span class="nb">int</span>


<span class="k">class</span> <span class="nc">App</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Implementing the workflow for the FeatureCloud platform.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    id: str</span>
<span class="sd">    coordinator: bool</span>
<span class="sd">    clients: list</span>

<span class="sd">    status_available: bool</span>
<span class="sd">    status_finished: bool</span>
<span class="sd">    status_message: str</span>
<span class="sd">    status_progress: float</span>
<span class="sd">    status_state: str</span>
<span class="sd">    status_destination: str</span>
<span class="sd">    status_smpc: dict</span>

<span class="sd">    default_smpc: dict</span>

<span class="sd">    data_incoming: list</span>
<span class="sd">    data_outgoing: list</span>
<span class="sd">    thread: threading.Thread</span>

<span class="sd">    states: Dict[str, AppState]</span>
<span class="sd">    transitions: Dict[str, Tuple[AppState, AppState, bool, bool]]</span>
<span class="sd">    transition_log: List[Tuple[datetime.datetime, str]]</span>
<span class="sd">    internal: dict</span>

<span class="sd">    current_state: str</span>


<span class="sd">    Methods</span>
<span class="sd">    -------</span>
<span class="sd">    handle_setup(client_id, coordinator, clients)</span>
<span class="sd">    handle_incoming(data)</span>
<span class="sd">    handle_outgoing()</span>
<span class="sd">    guarded_run()</span>
<span class="sd">    run()</span>
<span class="sd">    register()</span>
<span class="sd">    _register_state(name, state, participant, coordinator, **kwargs)</span>
<span class="sd">    register_transition(name, source, participant, coordinator)</span>
<span class="sd">    transition()</span>
<span class="sd">    log()</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coordinator</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clients</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">thread</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">status_available</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status_finished</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status_message</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status_progress</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status_state</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status_destination</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status_smpc</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">SMPCType</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">data_incoming</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_outgoing</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">default_smpc</span><span class="p">:</span> <span class="n">SMPCType</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;operation&#39;</span><span class="p">:</span> <span class="s1">&#39;add&#39;</span><span class="p">,</span> <span class="s1">&#39;serialization&#39;</span><span class="p">:</span> <span class="s1">&#39;json&#39;</span><span class="p">,</span> <span class="s1">&#39;shards&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;exponent&#39;</span><span class="p">:</span> <span class="mi">8</span><span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">current_state</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">AppState</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">AppState</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># self.transitions: Dict[</span>
        <span class="c1">#     str, Tuple[AppState, AppState, bool, bool]] = {}  # name =&gt; (source, target, participant, coordinator)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transitions</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span>
            <span class="nb">str</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">AppState</span><span class="p">,</span> <span class="n">AppState</span><span class="p">,</span> <span class="nb">bool</span><span class="p">,</span> <span class="nb">bool</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># name =&gt; (source, target, participant, coordinator, label)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">transition_log</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">internal</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Add terminal state</span>
        <span class="nd">@app_state</span><span class="p">(</span><span class="s1">&#39;terminal&#39;</span><span class="p">,</span> <span class="n">Role</span><span class="o">.</span><span class="n">BOTH</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="k">class</span> <span class="nc">TerminalState</span><span class="p">(</span><span class="n">AppState</span><span class="p">):</span>
            <span class="k">def</span> <span class="nf">register</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="k">pass</span>

            <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
                <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">handle_setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client_id</span><span class="p">,</span> <span class="n">coordinator</span><span class="p">,</span> <span class="n">clients</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; It will be called on startup and contains information about the</span>
<span class="sd">            execution context of this instance. And registers all of the states.</span>


<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        client_id: str</span>
<span class="sd">        coordinator: bool</span>
<span class="sd">        clients: list</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">client_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coordinator</span> <span class="o">=</span> <span class="n">coordinator</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clients</span> <span class="o">=</span> <span class="n">clients</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;id: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;coordinator: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">coordinator</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;clients: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">clients</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">current_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;initial&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_state</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;initial state not found&#39;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">LogLevel</span><span class="o">.</span><span class="n">FATAL</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">thread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">guarded_run</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">guarded_run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; run the workflow while trying to catch possible exceptions</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>  <span class="c1"># catch all  # noqa</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">status_message</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">status_state</span> <span class="o">=</span> <span class="n">State</span><span class="o">.</span><span class="n">ERROR</span><span class="o">.</span><span class="n">value</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">status_finished</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;    Runs the workflow, logs the current state, executes it,</span>
<span class="sd">               and handles the transition to the next desired state.</span>
<span class="sd">               Once the app transits to the terminal state, the workflow will be terminated.</span>

<span class="sd">       &quot;&quot;&quot;</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;state: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">current_state</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">transition</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_state</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;transition: </span><span class="si">{</span><span class="n">transition</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">transition</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">current_state</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">transition</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_state</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;terminal&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">status_progress</span> <span class="o">=</span> <span class="mf">1.0</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;done&#39;</span><span class="p">)</span>
                <span class="n">sleep</span><span class="p">(</span><span class="n">TERMINAL_WAIT</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">status_finished</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">return</span>
            <span class="n">sleep</span><span class="p">(</span><span class="n">TRANSITION_WAIT</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">register</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Registers all of the states transitions</span>
<span class="sd">            it should be called once all of the states are registered.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">:</span>
            <span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>
            <span class="n">state</span><span class="o">.</span><span class="n">register</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">handle_incoming</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">client</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; When new data arrives, it appends it to the</span>
<span class="sd">            `data_incoming` attribute to be accessible for app states.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        data: list</span>
<span class="sd">            encoded data</span>
<span class="sd">        client: str</span>
<span class="sd">            Id of the client that Sent the data</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_incoming</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">data</span><span class="p">,</span> <span class="n">client</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">handle_outgoing</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; When it is requested to send some data to other client/s</span>
<span class="sd">            it will be called to deliver the data to the FeatureCloud Controller.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_outgoing</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_outgoing</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_outgoing</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_outgoing</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_outgoing</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">status_available</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">status_destination</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">status_smpc</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">status_available</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">status_smpc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_smpc</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_outgoing</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">status_destination</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_outgoing</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_register_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">participant</span><span class="p">,</span> <span class="n">coordinator</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Instantiates a state, provides app-level information and adds it as part of the app workflow.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name: str</span>
<span class="sd">        state: AppState</span>
<span class="sd">        participant: bool</span>
<span class="sd">        coordinator: bool</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">transitions</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;state </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1"> already exists&#39;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">LogLevel</span><span class="o">.</span><span class="n">FATAL</span><span class="p">)</span>

        <span class="n">si</span> <span class="o">=</span> <span class="n">state</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">si</span><span class="o">.</span><span class="n">_app</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">si</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="n">si</span><span class="o">.</span><span class="n">participant</span> <span class="o">=</span> <span class="n">participant</span>
        <span class="n">si</span><span class="o">.</span><span class="n">coordinator</span> <span class="o">=</span> <span class="n">coordinator</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">[</span><span class="n">si</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">si</span>

    <span class="k">def</span> <span class="nf">register_transition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">source</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">target</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">participant</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">coordinator</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">label</span><span class="p">:</span> <span class="nb">str</span> <span class="ow">or</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Receives transition registration parameters, check the validity of its logic,</span>
<span class="sd">            and consider it as one possible transitions in the workflow.</span>
<span class="sd">            There will be exceptions if apps try to register a transition with contradicting roles.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name: str</span>
<span class="sd">            Name of the transition</span>
<span class="sd">        source: str</span>
<span class="sd">            Name of the source state</span>
<span class="sd">        target: str</span>
<span class="sd">            Name of the target state</span>
<span class="sd">        participant: bool</span>
<span class="sd">            Indicates whether the transition is allowed for participant role</span>
<span class="sd">        coordinator: bool</span>
<span class="sd">            Indicates whether the transition is allowed for the coordinator role</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">participant</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">coordinator</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;either participant or coordinator must be True&#39;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">LogLevel</span><span class="o">.</span><span class="n">FATAL</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">transitions</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;transition </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1"> already exists&#39;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">LogLevel</span><span class="o">.</span><span class="n">FATAL</span><span class="p">)</span>

        <span class="n">source_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">source_state</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;source state </span><span class="si">{</span><span class="n">source</span><span class="si">}</span><span class="s1"> not found&#39;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">LogLevel</span><span class="o">.</span><span class="n">FATAL</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">participant</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">source_state</span><span class="o">.</span><span class="n">participant</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;source state </span><span class="si">{</span><span class="n">source</span><span class="si">}</span><span class="s1"> not accessible for participants&#39;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">LogLevel</span><span class="o">.</span><span class="n">FATAL</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">coordinator</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">source_state</span><span class="o">.</span><span class="n">coordinator</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;source state </span><span class="si">{</span><span class="n">source</span><span class="si">}</span><span class="s1"> not accessible for the coordinator&#39;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">LogLevel</span><span class="o">.</span><span class="n">FATAL</span><span class="p">)</span>

        <span class="n">target_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">target_state</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;target state </span><span class="si">{</span><span class="n">target</span><span class="si">}</span><span class="s1"> not found&#39;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">LogLevel</span><span class="o">.</span><span class="n">FATAL</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">participant</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">target_state</span><span class="o">.</span><span class="n">participant</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;target state </span><span class="si">{</span><span class="n">target</span><span class="si">}</span><span class="s1"> not accessible for participants&#39;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">LogLevel</span><span class="o">.</span><span class="n">FATAL</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">coordinator</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">target_state</span><span class="o">.</span><span class="n">coordinator</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;target state </span><span class="si">{</span><span class="n">target</span><span class="si">}</span><span class="s1"> not accessible for the coordinator&#39;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">LogLevel</span><span class="o">.</span><span class="n">FATAL</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">transitions</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">source_state</span><span class="p">,</span> <span class="n">target_state</span><span class="p">,</span> <span class="n">participant</span><span class="p">,</span> <span class="n">coordinator</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">transition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Transits the app workflow to the unique next state based on</span>
<span class="sd">            current states, the role of the FeatureCloud client,</span>
<span class="sd">            and requirements of registered transitions for the current state.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name: str</span>
<span class="sd">            Name of the transition(which includes name of current and the next state).</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">transition</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transitions</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">transition</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;transition </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1"> not found&#39;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">LogLevel</span><span class="o">.</span><span class="n">FATAL</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">transition</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_state</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;current state unequal to source state&#39;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">LogLevel</span><span class="o">.</span><span class="n">FATAL</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">transition</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinator</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;cannot perform transition </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1"> as participant&#39;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">LogLevel</span><span class="o">.</span><span class="n">FATAL</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">transition</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinator</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;cannot perform transition </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1"> as coordinator&#39;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">LogLevel</span><span class="o">.</span><span class="n">FATAL</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">transition_log</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span> <span class="n">name</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_state</span> <span class="o">=</span> <span class="n">transition</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">log</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">level</span><span class="p">:</span> <span class="n">LogLevel</span> <span class="o">=</span> <span class="n">LogLevel</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Prints a log message or raises an exception according to the log level.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        msg : str</span>
<span class="sd">            message to be displayed</span>
<span class="sd">        level : LogLevel, default=LogLevel.DEBUG</span>
<span class="sd">            determines the channel (stdout, stderr) or whether to trigger an exception</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;[Time: </span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">.%m.%y %H:%M:%S&quot;</span><span class="p">)</span><span class="si">}</span><span class="s1">] [Level: </span><span class="si">{</span><span class="n">level</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s1">] </span><span class="si">{</span><span class="n">msg</span><span class="si">}</span><span class="s1">&#39;</span>

        <span class="k">if</span> <span class="n">level</span> <span class="o">==</span> <span class="n">LogLevel</span><span class="o">.</span><span class="n">FATAL</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">level</span> <span class="o">==</span> <span class="n">LogLevel</span><span class="o">.</span><span class="n">ERROR</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<div class="viewcode-block" id="AppState"><a class="viewcode-back" href="../../../../code.html#FeatureCloud.app.engine.app.AppState">[docs]</a><span class="k">class</span> <span class="nc">AppState</span><span class="p">(</span><span class="n">abc</span><span class="o">.</span><span class="n">ABC</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Defining custom states</span>

<span class="sd">    AppState is the class used when programming a FeatureCloud App to create</span>
<span class="sd">    states and to communicate with other clients. Generally, a FeatureCloud app</span>
<span class="sd">    consists of different states that all share the same AppState class.</span>
<span class="sd">    The states themselves are created as classes with the</span>
<span class="sd">    @app_state(&quot;statename&quot;) decorator.</span>
<span class="sd">    See the example below or the template apps for more details.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    ::</span>

<span class="sd">        # A simple example for a typical federated learning app</span>
<span class="sd">        from FeatureCloud.app.engine.app import AppState, app_state, Role, LogLevel</span>

<span class="sd">        # an intial state for loading the data</span>
<span class="sd">        @app_state(&quot;initial&quot;)</span>
<span class="sd">        class InitialState(AppState): # you can choose any fitting classname</span>
<span class="sd">          def register(self):</span>
<span class="sd">            self.register_transition(&quot;local_computation&quot;, Role.BOTH)</span>
<span class="sd">              # Role.BOTH means that this transition can be done by</span>
<span class="sd">              # the coordinator and a participant</span>
<span class="sd">          def run(self):</span>
<span class="sd">            # Here you can for example load the config file and the data</span>
<span class="sd">            dataFile = os.path.join(os.getcwd(), &quot;mnt&quot;, &quot;input&quot;, &quot;data.csv&quot;))</span>
<span class="sd">            data = pd.read_csv(dataFile)</span>
<span class="sd">            # Data can be stored for access in other states like this</span>
<span class="sd">            self.store(key = &quot;keyData&quot;, value=data)</span>
<span class="sd">            # Also store some intial model</span>
<span class="sd">            self.store(key = &quot;model&quot;, value=np.zeros(5))</span>
<span class="sd">            # to progress to another state, simply return the states name</span>
<span class="sd">            return &quot;local_computation&quot;</span>

<span class="sd">        # a state for the local computation</span>
<span class="sd">        @app_state</span>
<span class="sd">        class local_computation(AppState):</span>
<span class="sd">          def register(self):</span>
<span class="sd">            self.register_transition(&quot;aggregate_data&quot;, Role.COORDINATOR)</span>
<span class="sd">            self.register_transition(&quot;obtain_weights&quot;, Role.PARTICIPANT)</span>

<span class="sd">          def run(self):</span>
<span class="sd">            # do some local computations</span>
<span class="sd">            model = calculateThings(self.load(&quot;keyData&quot;), self.load(&quot;model&quot;))</span>
<span class="sd">              # loads the data and calculates some model</span>
<span class="sd">            self.send_data_to_coordinator(model,</span>
<span class="sd">                                        send_to_self=True,</span>
<span class="sd">                                        use_smpc=False)</span>
<span class="sd">            if self.is_coordinator:</span>
<span class="sd">              return &quot;aggregate&quot;</span>
<span class="sd">            else:</span>
<span class="sd">              return &quot;obtain_weights&quot;</span>

<span class="sd">        # a state just for obtaining the weights from the coordinator</span>
<span class="sd">        @app_state(&quot;obtain_weights&quot;)</span>
<span class="sd">        class obtainWeights(AppState):</span>
<span class="sd">          def register(self):</span>
<span class="sd">            self.register_transition(&quot;local_computation&quot;, Role.BOTH)</span>

<span class="sd">          def run(self):</span>
<span class="sd">            updated_model = self.await_data(n = 1,)</span>
<span class="sd">              # n=1 since we only expect one model from the coordinator</span>
<span class="sd">            self.store(&quot;model&quot;, updated_model)</span>
<span class="sd">            return &quot;local_computation&quot;</span>

<span class="sd">        # a state for the coordinator to aggregate all weights</span>
<span class="sd">        @app_state(&quot;aggregate_data&quot;)</span>
<span class="sd">        class aggregateDataState(AppState):</span>
<span class="sd">          def register(self):</span>
<span class="sd">            self.register_transition(&quot;obtain_weights&quot;, Role.COORDINATOR)</span>
<span class="sd">            self.register_transition(&quot;terminal&quot;, Role.COORDINATOR)</span>
<span class="sd">          def run(self):</span>
<span class="sd">            aggregated_model = self.aggregate_data(operation = SMPCOperation.ADD)</span>
<span class="sd">              # waits for every participant to send someting and then</span>
<span class="sd">              # adds them together</span>
<span class="sd">            updated_model = aggregated_model / len(self.clients)</span>
<span class="sd">            if stop_training_criteria: # if the training is done</span>
<span class="sd">              fp = open(os.path.join(&quot;mnt&quot;, &quot;output&quot;, &quot;trained_model.pyc&quot;), &quot;wb&quot;)</span>
<span class="sd">              np.save(fp, updated_model)</span>
<span class="sd">              return &quot;terminal&quot;</span>
<span class="sd">                # going to the terminal state will finnish the app and tell</span>
<span class="sd">                # all clients that the computation is done</span>
<span class="sd">            else:</span>
<span class="sd">              self.broadcast_data(updated_model, send_to_self = True)</span>
<span class="sd">              return &quot;obtain_weights&quot;</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    app: App</span>
<span class="sd">    name: str</span>
<span class="sd">    participant: bool</span>
<span class="sd">    coordinator: bool</span>

<span class="sd">    Methods</span>
<span class="sd">    -------</span>
<span class="sd">    register()</span>
<span class="sd">    run()</span>
<span class="sd">    register_transition(target, role, name)</span>
<span class="sd">    aggregate_data(operation, use_smpc)</span>
<span class="sd">    gather_data(is_json)</span>
<span class="sd">    await_data(n, unwrap, is_json)</span>
<span class="sd">    send_data_to_participant(data, destination)</span>
<span class="sd">    configure_smpc(exponent, shards, operation, serialization)</span>
<span class="sd">    send_data_to_coordinator(data, send_to_self, use_smpc)</span>
<span class="sd">    broadcast_data(data, send_to_self)</span>
<span class="sd">    update(message, progress, state)</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_app</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">participant</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coordinator</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="AppState.register"><a class="viewcode-back" href="../../../../code.html#FeatureCloud.app.engine.app.AppState.register">[docs]</a>    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">register</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; This is an abstract method that should be implemented by developers</span>
<span class="sd">            it calls AppState.register_transition to register transitions for state.</span>
<span class="sd">            it will be called in App.register method so that, once all states are defined,</span>
<span class="sd">            in a verifiable way, all app transitions can be registered.</span>

<span class="sd">        &quot;&quot;&quot;</span></div>

<div class="viewcode-block" id="AppState.run"><a class="viewcode-back" href="../../../../code.html#FeatureCloud.app.engine.app.AppState.run">[docs]</a>    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; It is an abstract method that should be implemented by developers,</span>
<span class="sd">            to execute all local or global operation and calculations of the state.</span>
<span class="sd">            It will be called in App.run() method so that the state perform its operations.</span>

<span class="sd">        &quot;&quot;&quot;</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_coordinator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_app</span><span class="o">.</span><span class="n">coordinator</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">clients</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_app</span><span class="o">.</span><span class="n">clients</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_app</span><span class="o">.</span><span class="n">id</span>

<div class="viewcode-block" id="AppState.register_transition"><a class="viewcode-back" href="../../../../code.html#FeatureCloud.app.engine.app.AppState.register_transition">[docs]</a>    <span class="k">def</span> <span class="nf">register_transition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">role</span><span class="p">:</span> <span class="n">Role</span> <span class="o">=</span> <span class="n">Role</span><span class="o">.</span><span class="n">BOTH</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="ow">or</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">label</span><span class="p">:</span> <span class="nb">str</span> <span class="ow">or</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Registers a transition in the state machine.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        target : str</span>
<span class="sd">            name of the target state</span>
<span class="sd">        role : Role, default=Role.BOTH</span>
<span class="sd">           role for which this transition is valid</span>
<span class="sd">        name : str or None, default=None</span>
<span class="sd">            name of the transition</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">target</span>
        <span class="n">participant</span><span class="p">,</span> <span class="n">coordinator</span> <span class="o">=</span> <span class="n">role</span><span class="o">.</span><span class="n">value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_app</span><span class="o">.</span><span class="n">register_transition</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">participant</span><span class="p">,</span> <span class="n">coordinator</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span></div>

<div class="viewcode-block" id="AppState.aggregate_data"><a class="viewcode-back" href="../../../../code.html#FeatureCloud.app.engine.app.AppState.aggregate_data">[docs]</a>    <span class="k">def</span> <span class="nf">aggregate_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">operation</span><span class="p">:</span> <span class="n">SMPCOperation</span> <span class="o">=</span> <span class="n">SMPCOperation</span><span class="o">.</span><span class="n">ADD</span><span class="p">,</span> <span class="n">use_smpc</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Waits for all participants (including the coordinator instance) to send data and returns the aggregated value.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        operation : SMPCOperation</span>
<span class="sd">            specifies the aggregation type</span>
<span class="sd">        use_smpc : bool, default=False</span>
<span class="sd">            if True, the data to be aggregated is expected to stem from an SMPC aggregation</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        aggregated value</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">use_smpc</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">await_data</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">unwrap</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">is_json</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># Data is aggregated already</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gather_data</span><span class="p">(</span><span class="n">is_json</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">_aggregate</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">operation</span><span class="p">)</span>  <span class="c1"># Data needs to be aggregated according to operation</span></div>

<div class="viewcode-block" id="AppState.gather_data"><a class="viewcode-back" href="../../../../code.html#FeatureCloud.app.engine.app.AppState.gather_data">[docs]</a>    <span class="k">def</span> <span class="nf">gather_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">is_json</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Waits for all participants (including the coordinator instance) to send data and returns a list containing the received data pieces. Only valid for the coordinator instance.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        is_json : bool, default=False</span>
<span class="sd">            if True, expects a JSON serialized values and deserializes it accordingly</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list of n data pieces, where n is the number of participants</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_app</span><span class="o">.</span><span class="n">coordinator</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_app</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;must be coordinator to use gather_data&#39;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">LogLevel</span><span class="o">.</span><span class="n">FATAL</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">await_data</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_app</span><span class="o">.</span><span class="n">clients</span><span class="p">),</span> <span class="n">unwrap</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">is_json</span><span class="o">=</span><span class="n">is_json</span><span class="p">)</span></div>

<div class="viewcode-block" id="AppState.await_data"><a class="viewcode-back" href="../../../../code.html#FeatureCloud.app.engine.app.AppState.await_data">[docs]</a>    <span class="k">def</span> <span class="nf">await_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">unwrap</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">is_json</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Waits for n data pieces and returns them.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        n : int, default=1</span>
<span class="sd">            number of data pieces to wait for</span>
<span class="sd">        unwrap : bool, default=True</span>
<span class="sd">            if True, will return the first element of the collected data (only useful if n = 1)</span>
<span class="sd">        is_json : bool, default=False</span>
<span class="sd">            if True, expects JSON serialized values and deserializes it accordingly</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list of data pieces (if n &gt; 1 or unwrap = False) or a single data piece (if n = 1 and unwrap = True)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_app</span><span class="o">.</span><span class="n">data_incoming</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">n</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_app</span><span class="o">.</span><span class="n">data_incoming</span><span class="p">[:</span><span class="n">n</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_app</span><span class="o">.</span><span class="n">data_incoming</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_app</span><span class="o">.</span><span class="n">data_incoming</span><span class="p">[</span><span class="n">n</span><span class="p">:]</span>
                <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">unwrap</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">_deserialize_incoming</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">is_json</span><span class="o">=</span><span class="n">is_json</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="p">[</span><span class="n">_deserialize_incoming</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data</span><span class="p">]</span>
            <span class="n">sleep</span><span class="p">(</span><span class="n">DATA_POLL_INTERVAL</span><span class="p">)</span></div>

<div class="viewcode-block" id="AppState.send_data_to_participant"><a class="viewcode-back" href="../../../../code.html#FeatureCloud.app.engine.app.AppState.send_data_to_participant">[docs]</a>    <span class="k">def</span> <span class="nf">send_data_to_participant</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">destination</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sends data to a particular participant identified by its ID.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        data : object</span>
<span class="sd">            data to be sent</span>
<span class="sd">        destination : str</span>
<span class="sd">            destination client ID</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">data</span> <span class="o">=</span> <span class="n">_serialize_outgoing</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">is_json</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">destination</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_app</span><span class="o">.</span><span class="n">id</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_app</span><span class="o">.</span><span class="n">data_incoming</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_app</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_app</span><span class="o">.</span><span class="n">data_outgoing</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">data</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">destination</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_app</span><span class="o">.</span><span class="n">status_destination</span> <span class="o">=</span> <span class="n">destination</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_app</span><span class="o">.</span><span class="n">status_smpc</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_app</span><span class="o">.</span><span class="n">status_available</span> <span class="o">=</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="AppState.send_data_to_coordinator"><a class="viewcode-back" href="../../../../code.html#FeatureCloud.app.engine.app.AppState.send_data_to_coordinator">[docs]</a>    <span class="k">def</span> <span class="nf">send_data_to_coordinator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">send_to_self</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">use_smpc</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sends data to the coordinator instance.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        data : object</span>
<span class="sd">            data to be sent</span>
<span class="sd">        send_to_self : bool, default=True</span>
<span class="sd">            if True, the data will also be sent internally to this instance (only applies to the coordinator instance)</span>
<span class="sd">        use_smpc : bool, default=False</span>
<span class="sd">            if True, the data will be sent as part of an SMPC aggregation step</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">data</span> <span class="o">=</span> <span class="n">_serialize_outgoing</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">is_json</span><span class="o">=</span><span class="n">use_smpc</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_app</span><span class="o">.</span><span class="n">coordinator</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">use_smpc</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">send_to_self</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_app</span><span class="o">.</span><span class="n">data_incoming</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_app</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_app</span><span class="o">.</span><span class="n">data_outgoing</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">data</span><span class="p">,</span> <span class="n">use_smpc</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_app</span><span class="o">.</span><span class="n">status_destination</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_app</span><span class="o">.</span><span class="n">status_smpc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_app</span><span class="o">.</span><span class="n">default_smpc</span> <span class="k">if</span> <span class="n">use_smpc</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_app</span><span class="o">.</span><span class="n">status_available</span> <span class="o">=</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="AppState.broadcast_data"><a class="viewcode-back" href="../../../../code.html#FeatureCloud.app.engine.app.AppState.broadcast_data">[docs]</a>    <span class="k">def</span> <span class="nf">broadcast_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">send_to_self</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Broadcasts data to all participants (only valid for the coordinator instance).</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        data : object</span>
<span class="sd">            data to be sent</span>
<span class="sd">        send_to_self : bool</span>
<span class="sd">            if True, the data will also be sent internally to this coordinator instance</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">data</span> <span class="o">=</span> <span class="n">_serialize_outgoing</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">is_json</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_app</span><span class="o">.</span><span class="n">coordinator</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_app</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;only the coordinator can broadcast data&#39;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">LogLevel</span><span class="o">.</span><span class="n">FATAL</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_app</span><span class="o">.</span><span class="n">data_outgoing</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">data</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_app</span><span class="o">.</span><span class="n">status_destination</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_app</span><span class="o">.</span><span class="n">status_smpc</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_app</span><span class="o">.</span><span class="n">status_available</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">send_to_self</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_app</span><span class="o">.</span><span class="n">data_incoming</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_app</span><span class="o">.</span><span class="n">id</span><span class="p">))</span></div>

<div class="viewcode-block" id="AppState.configure_smpc"><a class="viewcode-back" href="../../../../code.html#FeatureCloud.app.engine.app.AppState.configure_smpc">[docs]</a>    <span class="k">def</span> <span class="nf">configure_smpc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exponent</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span> <span class="n">shards</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">operation</span><span class="p">:</span> <span class="n">SMPCOperation</span> <span class="o">=</span> <span class="n">SMPCOperation</span><span class="o">.</span><span class="n">ADD</span><span class="p">,</span>
                       <span class="n">serialization</span><span class="p">:</span> <span class="n">SMPCSerialization</span> <span class="o">=</span> <span class="n">SMPCSerialization</span><span class="o">.</span><span class="n">JSON</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Configures successive usage of SMPC aggregation performed in the FeatureCloud controller.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        exponent : int, default=8</span>
<span class="sd">            exponent to be used for converting floating point numbers to fixed-point numbers</span>
<span class="sd">        shards : int, default=0</span>
<span class="sd">            number of secrets to be created, if 0, the total number of participants will be used</span>
<span class="sd">        operation : SMPCOperation, default=SMPCOperation.ADD</span>
<span class="sd">            operation to perform for aggregation</span>
<span class="sd">        serialization : SMPCSerialization, default=SMPCSerialization.JSON</span>
<span class="sd">            serialization to be used for the data</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_app</span><span class="o">.</span><span class="n">default_smpc</span><span class="p">[</span><span class="s1">&#39;exponent&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">exponent</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_app</span><span class="o">.</span><span class="n">default_smpc</span><span class="p">[</span><span class="s1">&#39;shards&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">shards</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_app</span><span class="o">.</span><span class="n">default_smpc</span><span class="p">[</span><span class="s1">&#39;operation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">operation</span><span class="o">.</span><span class="n">value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_app</span><span class="o">.</span><span class="n">default_smpc</span><span class="p">[</span><span class="s1">&#39;serialization&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">serialization</span><span class="o">.</span><span class="n">value</span></div>

<div class="viewcode-block" id="AppState.update"><a class="viewcode-back" href="../../../../code.html#FeatureCloud.app.engine.app.AppState.update">[docs]</a>    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">progress</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
               <span class="n">state</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">State</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Updates information about the execution.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        message : str</span>
<span class="sd">            message briefly summarizing what is happening currently</span>
<span class="sd">        progress : float</span>
<span class="sd">            number between 0 and 1, indicating the overall progress</span>
<span class="sd">        state : State or None</span>
<span class="sd">            overall state (running, error or action_required)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">message</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">message</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">40</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_app</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;message is too long (max: 40)&#39;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">LogLevel</span><span class="o">.</span><span class="n">FATAL</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">progress</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span><span class="n">progress</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">progress</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_app</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;progress must be between 0 and 1&#39;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">LogLevel</span><span class="o">.</span><span class="n">FATAL</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">state</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">state</span> <span class="o">!=</span> <span class="n">State</span><span class="o">.</span><span class="n">RUNNING</span> <span class="ow">and</span> <span class="n">state</span> <span class="o">!=</span> <span class="n">State</span><span class="o">.</span><span class="n">ERROR</span> <span class="ow">and</span> <span class="n">state</span> <span class="o">!=</span> <span class="n">State</span><span class="o">.</span><span class="n">ACTION</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_app</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;invalid state&#39;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">LogLevel</span><span class="o">.</span><span class="n">FATAL</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_app</span><span class="o">.</span><span class="n">status_message</span> <span class="o">=</span> <span class="n">message</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_app</span><span class="o">.</span><span class="n">status_progress</span> <span class="o">=</span> <span class="n">progress</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_app</span><span class="o">.</span><span class="n">status_state</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">value</span> <span class="k">if</span> <span class="n">state</span> <span class="k">else</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="AppState.store"><a class="viewcode-back" href="../../../../code.html#FeatureCloud.app.engine.app.AppState.store">[docs]</a>    <span class="k">def</span> <span class="nf">store</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Store allows to share data across different AppState instances.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        key: str</span>
<span class="sd">        value:</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_app</span><span class="o">.</span><span class="n">internal</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span></div>

<div class="viewcode-block" id="AppState.load"><a class="viewcode-back" href="../../../../code.html#FeatureCloud.app.engine.app.AppState.load">[docs]</a>    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Load allows to access data shared across different AppState instances.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        key: str</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        value:</span>
<span class="sd">            Value stored previously using store</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_app</span><span class="o">.</span><span class="n">internal</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span></div>

<div class="viewcode-block" id="AppState.log"><a class="viewcode-back" href="../../../../code.html#FeatureCloud.app.engine.app.AppState.log">[docs]</a>    <span class="k">def</span> <span class="nf">log</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">level</span><span class="p">:</span> <span class="n">LogLevel</span> <span class="o">=</span> <span class="n">LogLevel</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Prints a log message or raises an exception according to the log level.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        msg : str</span>
<span class="sd">            message to be displayed</span>
<span class="sd">        level : LogLevel, default=LogLevel.DEBUG</span>
<span class="sd">            determines the channel (stdout, stderr) or whether to trigger an exception</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_app</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;[State: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">] </span><span class="si">{</span><span class="n">msg</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">level</span><span class="p">)</span></div></div>


<span class="k">def</span> <span class="nf">app_state</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">role</span><span class="p">:</span> <span class="n">Role</span> <span class="o">=</span> <span class="n">Role</span><span class="o">.</span><span class="n">BOTH</span><span class="p">,</span> <span class="n">app_instance</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">App</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">app_instance</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">app_instance</span> <span class="o">=</span> <span class="n">app</span>

    <span class="n">participant</span><span class="p">,</span> <span class="n">coordinator</span> <span class="o">=</span> <span class="n">role</span><span class="o">.</span><span class="n">value</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">participant</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">coordinator</span><span class="p">:</span>
        <span class="n">app_instance</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;either participant or coordinator must be True&#39;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">LogLevel</span><span class="o">.</span><span class="n">FATAL</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="n">state_class</span><span class="p">):</span>
        <span class="n">app_instance</span><span class="o">.</span><span class="n">_register_state</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">state_class</span><span class="p">,</span> <span class="n">participant</span><span class="p">,</span> <span class="n">coordinator</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">state_class</span>

    <span class="k">return</span> <span class="n">func</span>


<span class="k">def</span> <span class="nf">_serialize_outgoing</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">is_json</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Transforms a Python data object into a byte serialization.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data : object</span>
<span class="sd">        data to serialize</span>
<span class="sd">    is_json : bool, default=False</span>
<span class="sd">        indicates whether JSON serialization is required</span>

<span class="sd">    Returns</span>
<span class="sd">    ----------</span>
<span class="sd">    serialized data as bytes</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_json</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">pickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_deserialize_incoming</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">is_json</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Transforms serialized data bytes into a Python object.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data : bytes</span>
<span class="sd">        data to deserialize</span>
<span class="sd">    is_json : bool, default=False</span>
<span class="sd">        indicates whether JSON deserialization should be used</span>

<span class="sd">    Returns</span>
<span class="sd">    ----------</span>
<span class="sd">    deserialized data</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_json</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">pickle</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_aggregate</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">operation</span><span class="p">:</span> <span class="n">SMPCOperation</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Aggregates a list of received values.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data : array_like</span>
<span class="sd">        list of data pieces</span>
<span class="sd">    operation : SMPCOperation</span>
<span class="sd">        operation to use for aggregation (add or multiply)</span>

<span class="sd">    Returns</span>
<span class="sd">    ----------</span>
<span class="sd">    aggregated value</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">data_np</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data</span><span class="p">]</span>

    <span class="n">aggregate</span> <span class="o">=</span> <span class="n">data_np</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">operation</span> <span class="o">==</span> <span class="n">SMPCOperation</span><span class="o">.</span><span class="n">ADD</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data_np</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
            <span class="n">aggregate</span> <span class="o">=</span> <span class="n">aggregate</span> <span class="o">+</span> <span class="n">d</span>

    <span class="k">if</span> <span class="n">operation</span> <span class="o">==</span> <span class="n">SMPCOperation</span><span class="o">.</span><span class="n">MULTIPLY</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data_np</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
            <span class="n">aggregate</span> <span class="o">=</span> <span class="n">aggregate</span> <span class="o">*</span> <span class="n">d</span>

    <span class="k">return</span> <span class="n">aggregate</span>


<span class="n">app</span> <span class="o">=</span> <span class="n">App</span><span class="p">()</span>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<p class="logo">
  <a href="../../../../index.html">
    <img class="logo" src="../../../../_static/fc_logo.svg" alt="Logo"/>
    
  </a>
</p>








<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../quick_start.html">Quickstart</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../complete_description.html">Full description</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../code.html">API Connector Python</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../../index.html">Documentation overview</a><ul>
  <li><a href="../../../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2023, author names.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 5.0.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>